# doc-srv — Сервер корпоративной документации

Легковесный HTTP-сервер на Go для организации, хранения и поиска нормативных документов (PDF). Проект оформлен в корпоративном стиле и поставляется в виде единого исполняемого файла.

## Возможности

*   **Структура**: Автоматическое рекурсивное сканирование папки `docs` и всех подпапок.
*   **Разделы**: Каждый подкаталог с PDF/`README.md` образует отдельный раздел (например, `HR`, `HR/2025`).
*   **Поиск**: Фильтрация документов по названию и по содержимому README на лету (JS).
*   **Описания разделов**: Поддержка `README.md` в папках любого уровня (рендеринг Markdown в HTML с корректной подстановкой ссылок и картинок).
*   **Производительность**: Кэширование структуры документов в памяти с настраиваемым TTL (по умолчанию 5 минут).
*   **Логирование**: Встроенная ротация логов доступа с форматом, близким к nginx (`access.log` по умолчанию, путь настраивается).
*   **Конфигурируемость**: Настройки через `config.yaml` + возможность переопределения ключевых параметров флагами.
*   **Portable**: Все ресурсы (HTML, CSS) вшиты в бинарный файл.

## Установка и запуск

### Локальный запуск (для разработки)

1.  Склонируйте репозиторий.
2.  При необходимости отредактируйте `config.yaml` (см. раздел ниже).
3.  Запустите:
    ```bash
    go run .
    ```
4.  Откройте браузер: http://localhost:8080

### Сборка и деплой

Для создания исполняемого файла (Windows):

```bash
go build -o doc-srv.exe .
```

Для кросс-компиляции под Windows (если собираете на Linux/macOS):

```bash
GOOS=windows GOARCH=amd64 go build -o doc-srv.exe .
```

**На сервере:**

1.  Скопируйте `doc-srv.exe` и `config.yaml` на сервер в одну папку.
2.  Создайте папку `docs` рядом с файлом (или укажите другой путь в `config.yaml` в поле `docs_dir`).
3.  Создайте структуру папок отделов внутри `docs` и наполните их PDF-файлами.
    *   *Опционально*: добавьте `README.md` в любую папку раздела (в т.ч. во вложенные), чтобы она отображалась как описание.
4.  Запустите сервер:
    ```powershell
    .\doc-srv.exe
    ```

### Установка как служба Windows (Service)

Вы можете установить приложение как системную службу, чтобы оно запускалось автоматически при старте Windows.

1.  Запустите командную строку (PowerShell или CMD) **от имени администратора**.
2.  Убедитесь, что рядом с `doc-srv.exe` лежит корректный `config.yaml`.
3.  Установите службу (будет запомнен путь к конфигу и переопределения, если есть):
    ```powershell
    .\doc-srv.exe -config "config.yaml" -service install
    ```
    *При установке можно переопределить порт и каталог документов поверх конфига:*
    ```powershell
    .\doc-srv.exe -config "config.yaml" -port 9090 -dir "C:\Docs" -service install
    ```
4.  Запустите службу:
    ```powershell
    .\doc-srv.exe -service start
    ```

Для остановки и удаления:
```powershell
.\doc-srv.exe -service stop
.\doc-srv.exe -service uninstall
```

## Конфигурация (config.yaml)

По умолчанию сервер читает настройки из файла `config.yaml` в рабочей директории.
Все поля опциональны — если какое-то поле не указано, используется значение по умолчанию.

Пример:

```yaml
docs_dir: "./docs"          # корень дерева документов
port: "8080"                # порт HTTP-сервера

cache_ttl: "5m"             # TTL кэша структуры документов (Go duration: 30s, 5m, 1h)

read_timeout: "15s"         # таймаут на чтение запроса
write_timeout: "15s"        # таймаут на отправку ответа
idle_timeout: "60s"         # idle timeout для keep-alive соединений
read_header_timeout: "5s"   # таймаут на чтение HTTP-заголовков

log_file: "./log/access.log" # путь к access-логу; при необходимости подкаталоги будут созданы автоматически
```

Относительные пути (`./docs`, `./log/access.log`) работают одинаково на Windows и Linux. Для абсолютных
путей на Windows можно использовать вид `C:/Docs` или одинарные кавычки в YAML: `docs_dir: 'C:\\Docs'`.

## Структура папок (пример)

```text
.
├── doc-srv.exe
├── config.yaml
├── log/
│   └── access.log         # Создается автоматически при первом запуске
└── docs/
    ├── Приказ_1.pdf       # Попадет в раздел "Общее"
    ├── HR/
    │   ├── instruction.pdf
    │   ├── README.md      # Описание раздела HR
    │   └── 2025/
    │       ├── README.md  # Описание подраздела HR/2025
    │       └── plan.pdf
    └── IT/
        └── network.pdf
```

## Мониторинг

Сервис предоставляет простой health-эндпойнт для мониторинга:

* `GET /healthz` — возвращает `200 OK` и тело `ok`, если процесс жив и каталог `docs_dir` доступен.
* Если каталог с документами недоступен (удалён, не смонтирован сетевой диск и т.п.), возвращается `500 Internal Server Error`.
* Запросы к `/healthz` по умолчанию **не попадают** в `access.log`, чтобы не засорять его частыми проверками.

## Разработка

Проект использует Go 1.25+.

Запуск тестов:
```bash
go test -v
```
